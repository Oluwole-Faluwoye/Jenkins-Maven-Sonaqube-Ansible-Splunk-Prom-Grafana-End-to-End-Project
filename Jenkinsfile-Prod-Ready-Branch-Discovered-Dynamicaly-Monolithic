def COLOR_MAP = [
    'SUCCESS': 'good',
    'FAILURE': 'danger',
    'UNSTABLE': 'danger'
]

pipeline {
    agent any

    environment {
        WORKSPACE = "${env.WORKSPACE}"
    }

    tools { 
        maven 'localMaven'
        jdk 'localJdk'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: "*/${env.BRANCH_NAME}"]],
                          userRemoteConfigs: [[url: env.GIT_REPO]]])
            }
        }

        stage('Build') {
            steps {
                script { runMaven('clean package', env.NEXUS_URL) }
            }
            post { success { archiveArtifacts artifacts: '**/*.war' } }
        }

        stage('Unit Test') {
            steps { script { runMaven('test', env.NEXUS_URL) } }
        }

        stage('Integration Test') {
            steps { script { runMaven('verify -DskipUnitTests', env.NEXUS_URL) } }
        }

        stage('Checkstyle Analysis') {
            steps { script { runMaven('checkstyle:checkstyle', env.NEXUS_URL) } }
            post { success { echo 'Generated Checkstyle Analysis Result' } }
        }

        stage('SonarQube Inspection') {
            when { expression { return env.SONAR_HOST_URL != null } }
            steps {
                withCredentials([string(credentialsId: 'Sonarqube-Token', variable: 'SONAR_TOKEN')]) {
                    script {
                        runMaven("sonar:sonar -Dsonar.projectKey=Java-WebApp-Project -Dsonar.host.url=${env.SONAR_HOST_URL} -Dsonar.login=$SONAR_TOKEN", env.NEXUS_URL)
                    }
                }
            }
        }

        stage('SonarQube GateKeeper') {
            when { expression { return env.SONAR_HOST_URL != null } }
            steps { timeout(time: 1, unit: 'HOURS') { waitForQualityGate abortPipeline: true } }
        }

        stage('Nexus Artifact Upload') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'Nexus-Credential', usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
                    nexusArtifactUploader(
                        nexusVersion: 'nexus3',
                        protocol: 'http',
                        nexusUrl: env.NEXUS_URL,
                        groupId: 'webapp',
                        version: "${env.BUILD_ID}-${env.BUILD_TIMESTAMP}",
                        repository: 'maven-project-releases',
                        credentialsId: 'Nexus-Credential',
                        artifacts: [[
                            artifactId: 'webapp',
                            classifier: '',
                            file: "${WORKSPACE}/webapp/target/webapp.war",
                            type: 'war'
                        ]]
                    )
                }
            }
        }

        // ---------------- Deployment logic based on branch ----------------
        stage('Deploy') {
            steps {
                script {
                    if (env.BRANCH_NAME.startsWith('feature')) {
                        echo "Feature branch detected: Build & Test only"
                    } else if (env.BRANCH_NAME == 'dev') {
                        deployAnsible('dev')
                    } else if (env.BRANCH_NAME == 'stage') {
                        deployAnsible('stage')
                    } else if (env.BRANCH_NAME == 'main') {
                        deployAnsible('prod')
                    } else {
                        echo "No deployment configured for branch ${env.BRANCH_NAME}"
                    }
                }
            }
        }

        stage('QA Approval for Prod') {
            when { expression { return env.BRANCH_NAME == 'main' } }
            steps { input('Proceed to Production?') }
        }

    }

    post {
        always {
            slackSend channel: '#af-cicd-pipeline',
                      color: COLOR_MAP[currentBuild.currentResult],
                      message: "*${currentBuild.currentResult}:* Job '${env.JOB_NAME}' Build #${env.BUILD_NUMBER}\nWorkspace: ${env.WORKSPACE}\nBranch: ${env.BRANCH_NAME}\nMore info: ${env.BUILD_URL}"
        }
    }
}

// ---------------- Helper Functions ----------------
def runMaven(mavenGoal, nexusUrl) {
    withCredentials([
        usernamePassword(credentialsId: 'Nexus-Credential', usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS'),
        string(credentialsId: 'Sonarqube-Token', variable: 'SONAR_TOKEN')
    ]) {
        configFileProvider([configFile(fileId: 'maven-settings-template', variable: 'MAVEN_SETTINGS')]) {
            script {
                TMP_SETTINGS = "${env.WORKSPACE}/tmp-settings.xml"
                try {
                    sh """
                    cp \$MAVEN_SETTINGS $TMP_SETTINGS
                    sed -i 's|\\\${username}|$NEXUS_USER|g' $TMP_SETTINGS
                    sed -i 's|\\\${password}|$NEXUS_PASS|g' $TMP_SETTINGS
                    sed -i 's|\\\${nexus_private_ip}|$nexusUrl|g' $TMP_SETTINGS
                    mvn $mavenGoal --settings $TMP_SETTINGS
                    """
                } finally {
                    sh "rm -f $TMP_SETTINGS"
                }
            }
        }
    }
}

def deployAnsible(hosts) {
    withCredentials([usernamePassword(credentialsId: 'Ansible-Credential', usernameVariable: 'USER_NAME', passwordVariable: 'PASSWORD')]) {
        sh """
        ansible-playbook \
        -i ${WORKSPACE}/ansible-config/aws_ec2.yaml \
        ${WORKSPACE}/deploy.yaml \
        --extra-vars "ansible_user=$USER_NAME ansible_password=$PASSWORD hosts=tag_Environment_$hosts workspace_path=$WORKSPACE"
        """
    }
}
